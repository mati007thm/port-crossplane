name: Sync control plane gitops
permissions:
  contents: write
  pull-requests: write

on:
  workflow_dispatch:
    inputs:
      operation:
        required: true
        description: "Delete, Update or create"
        type: string
      triggeringUser:
        required: true
        description: "The email of the triggering user"
        type: string
      runId:
        required: true
        description: "Port's Run ID"
        type: string
      manifest:
        required: true
        description: "The K8s manifest generated by Port"
        type: string
      folder:
        required: true
        description: Folder where the resource will be stored
        default: "./argocd-apps/control-plane/manifests"
        type: string

jobs:
  open-pr:
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v2

      - uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{inputs.runId}} 
          icon: GithubActions
          logMessage: "Creating branch with name runs/${{inputs.runId}} üèÉüèª‚Äç‚ôÇÔ∏è"

      - name: create-branch
        run: |
          git checkout -b runs/${{inputs.runId}}

      - uses: actions/setup-python@v5
        with:
          python-version: '3.10' 

      - name: Update manifests folder
        run: |
          echo '${{ inputs.manifest }}' | jq .  > temp.json
          yaml_data=$(yq -p json -o yaml temp.json)
          name=$(echo '${{ inputs.manifest }}' | jq -r .metadata.name)
          if [ "${{ inputs.operation }}" = "DELETE" ]; then
            rm -f "${{ inputs.folder }}/$name.yaml"
          else
            echo "$yaml_data" > "${{ inputs.folder }}/$name.yaml"
          fi
          rm -f temp.json

      - uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{inputs.runId}} 
          icon: GithubActions
          logMessage: "Creating a PR with the changes of the new resource in folder ${{ inputs.folder }} üöÄ"

      - name: create pr 
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "GitHub Action"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "chore: ${{ inputs.operation }} resource by ${{ inputs.triggeringUser }}"
          git push origin runs/${{inputs.runId}}

          gh auth setup-git
          gh pr create \
            --title "chore: ${{ inputs.operation }} resource" \
            --body "This PR was created by the workflow triggered by ${{inputs.triggeringUser}}" \
            --base main \
            --head runs/${{inputs.runId}}

      - name: merge pr
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Attempting to merge PR for branch runs/${{inputs.runId}}..."
          for i in {1..5}; do
            gh pr view runs/${{inputs.runId}} && break
            echo "Waiting for PR to become available..."
            sleep 2
          done

          if ! gh pr merge runs/${{inputs.runId}} --merge --admin --delete-branch; then
            echo "‚ùå Merge failed"
            exit 1
          fi

      - name: Log success to Port
        if: success()
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{inputs.runId}} 
          icon: GithubActions
          logMessage: "‚úÖ Created and merged a new PR successfully"

      - name: Log failure to Port
        if: failure()
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{inputs.runId}} 
          icon: GithubActions
          logMessage: | 
            ‚ùå Failed to create or merge the PR
            Check the job run logs in Github to learn more üìú:
              ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}